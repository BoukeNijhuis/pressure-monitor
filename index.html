<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNMI Air Pressure Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0052a3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin: 10px 0; color: #666; }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 500px;
        }
    </style>
</head>
<body>
    <h1>KNMI Air Pressure (2021-2030)</h1>
    
    <div class="controls">
        <button id="loadBtn" onclick="loadData()">Load Data</button>
        <button id="lastDayBtn" onclick="filterRange(1)" disabled>Last Day</button>
        <button id="lastWeekBtn" onclick="filterRange(7)" disabled>Last Week</button>
        <button id="lastTwoWeeksBtn" onclick="filterRange(14)" disabled>Last 2 Weeks</button>
        <button id="lastMonthBtn" onclick="filterRange(30)" disabled>Last Month</button>
        <button id="resetZoomBtn" onclick="resetZoom()" disabled>Reset Zoom</button>
        <button id="showAllBtn" onclick="showAllData()" disabled>Show All</button>
        <div id="status"></div>
        <div id="info"></div>
    </div>

    <div class="chart-container">
        <canvas id="pressureChart"></canvas>
    </div>

    <script>
        let chart = null;
        let allLabels = [];
        let allData = [];
        let allDates = [];

        window.addEventListener('DOMContentLoaded', loadData);

        async function loadData() {
            const btn = document.getElementById('loadBtn');
            const status = document.getElementById('status');
            const info = document.getElementById('info');
            
            btn.disabled = true;
            status.textContent = 'Downloading ZIP file...';
            
            const url = 'https://cdn.knmi.nl/knmi/map/page/klimatologie/gegevens/uurgegevens/uurgeg_260_2021-2030.zip';
            
            try {
                let response = await fetch(url);
                
                if (!response.ok) {
                    status.textContent = 'Direct download failed, trying CORS proxy...';
                    response = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
                }
                
                if (!response.ok) throw new Error('Download failed');
                
                status.textContent = 'Extracting ZIP file...';
                const arrayBuffer = await response.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                
                const files = Object.keys(zip.files);
                status.textContent = `Found ${files.length} file(s): ${files.join(', ')}`;
                
                let dataText = '';
                for (const filename of files) {
                    if (filename.endsWith('.txt') || filename.endsWith('.asc') || !filename.includes('.')) {
                        const file = zip.files[filename];
                        dataText = await file.async('string');
                        break;
                    }
                }
                
                if (!dataText) {
                    const firstFile = files[0];
                    const file = zip.files[firstFile];
                    dataText = await file.async('string');
                }
                
                status.textContent = 'Parsing data...';
                parseData(dataText);
                
                status.textContent = `Loaded ${allData.length} data points`;
                info.textContent = `Date range: ${allLabels[0]} to ${allLabels[allLabels.length - 1]}`;
                
                filterRange(14);
                document.getElementById('resetZoomBtn').disabled = false;
                document.getElementById('lastDayBtn').disabled = false;
                document.getElementById('lastWeekBtn').disabled = false;
                document.getElementById('lastTwoWeeksBtn').disabled = false;
                document.getElementById('lastMonthBtn').disabled = false;
                document.getElementById('showAllBtn').disabled = false;
                
            } catch (error) {
                status.textContent = 'Error: ' + error.message;
                console.error(error);
            }
            
            btn.disabled = false;
        }

        function parseData(text) {
            allData = [];
            allLabels = [];
            allDates = [];
            
            const lines = text.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed === '' || trimmed.startsWith('BRON') || trimmed.startsWith('Opmerking') || 
                    trimmed.startsWith('SOURCE') || trimmed.startsWith('Comment') || trimmed.startsWith('YYYYMMDD')) continue;
                
                const parts = trimmed.split(',');
                
                if (parts.length >= 15) {
                    try {
                        const dateStr = parts[1];
                        const hour = parseInt(parts[2]);
                        
                        if (!dateStr || dateStr.length !== 8 || isNaN(hour)) continue;
                        
                        const year = dateStr.substring(0, 4);
                        const month = dateStr.substring(4, 6);
                        const day = dateStr.substring(6, 8);
                        
                        const date = new Date(year, month - 1, day, hour);
                        
                        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const dayName = dayNames[date.getDay()];
                        const monthName = monthNames[date.getMonth()];
                        const dateLabel = `${dayName} ${parseInt(day)} ${monthName} ${hour.toString().padStart(2, '0')}:00`;
                        
                        const pressureRaw = parseFloat(parts[14]);
                        if (isNaN(pressureRaw) || pressureRaw < 9000 || pressureRaw > 11000) continue;
                        
                        const pressure = pressureRaw / 10;
                        
                        allLabels.push(dateLabel);
                        allData.push(pressure);
                        allDates.push(date);
                    } catch (e) {
                        continue;
                    }
                }
            }
        }

        function createChart(labels, data) {
            const ctx = document.getElementById('pressureChart').getContext('2d');
            
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Air Pressure (hPa)',
                        data: data,
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: (items) => items[0]?.label || ''
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 20,
                                maxRotation: 45
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Pressure (hPa)'
                            }
                        }
                    }
                }
            });
        }

        function resetZoom() {
            if (chart) {
                chart.resetZoom();
            }
        }

        function filterRange(days) {
            if (allDates.length === 0) return;
            
            const lastDate = allDates[allDates.length - 1];
            const cutoffDate = new Date(lastDate.getTime() - days * 24 * 60 * 60 * 1000);
            
            const filteredLabels = [];
            const filteredData = [];
            
            for (let i = 0; i < allDates.length; i++) {
                if (allDates[i] >= cutoffDate) {
                    filteredLabels.push(allLabels[i]);
                    filteredData.push(allData[i]);
                }
            }
            
            createChart(filteredLabels, filteredData);
            document.getElementById('info').textContent = `Showing last ${days} day(s): ${filteredLabels[0]} to ${filteredLabels[filteredLabels.length - 1]}`;
        }

        function showAllData() {
                const lastDate = allDates[allDates.length - 1];
                const cutoffDate = new Date(lastDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                
                const filteredLabels = [];
                const filteredData = [];
                
                for (let i = 0; i < allDates.length; i++) {
                    if (allDates[i] >= cutoffDate) {
                        filteredLabels.push(allLabels[i]);
                        filteredData.push(allData[i]);
                    }
                }
                
                createChart(filteredLabels, filteredData);
                document.getElementById('info').textContent = `Showing last 2 weeks: ${filteredLabels[0]} to ${filteredLabels[filteredLabels.length - 1]}`;
        }
    </script>
</body>
</html>
