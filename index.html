<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNMI Air Pressure Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0052a3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .locale-buttons { float: right; }
        .locale-buttons button { padding: 2px 8px; font-size: 20px; background: transparent; color: #333; border: 1px solid #ccc; border-radius: 4px; }
        .locale-buttons button.active { background: transparent; border-color: #0066cc; }
        #status { margin: 10px 0; color: #666; }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 500px;
        }
    </style>
</head>
<body>
    <h1 id="title">KNMI Luchtdruk (De Bilt)</h1>
    
    <div class="controls">
        <div class="locale-buttons">
            <button id="enBtn" onclick="setLocale('en')">ðŸ‡¬ðŸ‡§</button>
            <button id="nlBtn" onclick="setLocale('nl')" class="active">ðŸ‡³ðŸ‡±</button>
        </div>
        <button id="lastDayBtn" onclick="filterRange(1)" disabled>Laatste dag</button>
        <button id="lastWeekBtn" onclick="filterRange(7)" disabled>Laatste week</button>
        <button id="lastTwoWeeksBtn" onclick="filterRange(14)" disabled>Laatste 2 weken</button>
        <button id="lastMonthBtn" onclick="filterRange(30)" disabled>Laatste maand</button>
    </div>

    <div class="chart-container">
        <canvas id="pressureChart"></canvas>
    </div>

    <script>
        let chart = null;
        let allLabels = [];
        let allData = [];
        let allDates = [];
        let currentLocale = 'nl';

        const translations = {
            en: {
                title: 'KNMI Air Pressure (De Bilt)',
                lastDay: 'Last Day',
                lastWeek: 'Last Week',
                lastTwoWeeks: 'Last 2 Weeks',
                lastMonth: 'Last Month',
                downloading: 'Downloading ZIP file...',
                extracting: 'Extracting ZIP file...',
                found: 'Found',
                files: 'file(s):',
                parsing: 'Parsing data...',
                loaded: 'Loaded',
                dataPoints: 'data points',
                dateRange: 'Date range:',
                to: 'to',
                showingLast: 'Showing last',
                days: 'day(s):',
                directFailed: 'Direct download failed, trying CORS proxy...',
                downloadFailed: 'Download failed',
                error: 'Error:',
                pressure: 'Air Pressure (hPa)',
                dateFormat: 'EEE d MMM'
            },
            nl: {
                title: 'KNMI Luchtdruk (De Bilt)',
                lastDay: 'Laatste dag',
                lastWeek: 'Laatste week',
                lastTwoWeeks: 'Laatste 2 weken',
                lastMonth: 'Laatste maand',
                downloading: 'ZIP bestand downloaden...',
                extracting: 'ZIP bestand uitpakken...',
                found: 'Gevonden',
                files: 'bestand(en):',
                parsing: 'Data verwerken...',
                loaded: 'Geladen',
                dataPoints: 'datapunten',
                dateRange: 'Datumbereik:',
                to: 'tot',
                showingLast: 'Laatste',
                days: 'dag(en):',
                directFailed: 'Directe download mislukt, CORS proxy proberen...',
                downloadFailed: 'Download mislukt',
                error: 'Fout:',
                pressure: 'Luchtdruk (hPa)',
                dateFormat: 'EEE d MMM'
            }
        };

        function t(key) {
            return translations[currentLocale][key];
        }

        function setLocale(locale) {
            currentLocale = locale;
            document.getElementById('enBtn').classList.toggle('active', locale === 'en');
            document.getElementById('nlBtn').classList.toggle('active', locale === 'nl');
            document.getElementById('title').textContent = t('title');
            
            document.getElementById('lastDayBtn').textContent = t('lastDay');
            document.getElementById('lastWeekBtn').textContent = t('lastWeek');
            document.getElementById('lastTwoWeeksBtn').textContent = t('lastTwoWeeks');
            document.getElementById('lastMonthBtn').textContent = t('lastMonth');
            
            if (allDates.length > 0) {
                regenerateLabels();
                filterRange(14);
            }
        }

        function regenerateLabels() {
            const dayNamesEn = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const monthNamesEn = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const dayNamesNl = ['Zo', 'Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za'];
            const monthNamesNl = ['Jan', 'Feb', 'Mrt', 'Apr', 'Mei', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
            
            allLabels = [];
            for (const date of allDates) {
                const hour = date.getHours();
                const day = date.getDate();
                let dateLabel;
                if (currentLocale === 'nl') {
                    const dayName = dayNamesNl[date.getDay()];
                    const monthName = monthNamesNl[date.getMonth()];
                    dateLabel = `${dayName} ${day} ${monthName} ${hour.toString().padStart(2, '0')}:00`;
                } else {
                    const dayName = dayNamesEn[date.getDay()];
                    const monthName = monthNamesEn[date.getMonth()];
                    dateLabel = `${dayName} ${day} ${monthName} ${hour.toString().padStart(2, '0')}:00`;
                }
                allLabels.push(dateLabel);
            }
        }

        window.addEventListener('DOMContentLoaded', loadData);

        async function loadData() {
            const url = 'https://cdn.knmi.nl/knmi/map/page/klimatologie/gegevens/uurgegevens/uurgeg_260_2021-2030.zip';
            
            try {
                let response = await fetch(url);
                
                if (!response.ok) {
                    response = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
                }
                
                if (!response.ok) throw new Error(t('downloadFailed'));
                
                const arrayBuffer = await response.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                
                const files = Object.keys(zip.files);
                
                let dataText = '';
                for (const filename of files) {
                    if (filename.endsWith('.txt') || filename.endsWith('.asc') || !filename.includes('.')) {
                        const file = zip.files[filename];
                        dataText = await file.async('string');
                        break;
                    }
                }
                
                if (!dataText) {
                    const firstFile = files[0];
                    const file = zip.files[firstFile];
                    dataText = await file.async('string');
                }
                
                parseData(dataText);
                
                filterRange(14);
                document.getElementById('lastDayBtn').disabled = false;
                document.getElementById('lastWeekBtn').disabled = false;
                document.getElementById('lastTwoWeeksBtn').disabled = false;
                document.getElementById('lastMonthBtn').disabled = false;
                
            } catch (error) {
                console.error(error);
            }
        }

        function parseData(text) {
            allData = [];
            allLabels = [];
            allDates = [];
            
            const dayNamesEn = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const monthNamesEn = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const dayNamesNl = ['Zo', 'Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za'];
            const monthNamesNl = ['Jan', 'Feb', 'Mrt', 'Apr', 'Mei', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
            
            const lines = text.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed === '' || trimmed.startsWith('BRON') || trimmed.startsWith('Opmerking') || 
                    trimmed.startsWith('SOURCE') || trimmed.startsWith('Comment') || trimmed.startsWith('YYYYMMDD')) continue;
                
                const parts = trimmed.split(',');
                
                if (parts.length >= 15) {
                    try {
                        const dateStr = parts[1];
                        const hour = parseInt(parts[2]);
                        
                        if (!dateStr || dateStr.length !== 8 || isNaN(hour)) continue;
                        
                        const year = dateStr.substring(0, 4);
                        const month = dateStr.substring(4, 6);
                        const day = dateStr.substring(6, 8);
                        
                        const date = new Date(year, month - 1, day, hour);
                        
                        let dateLabel;
                        if (currentLocale === 'nl') {
                            const dayName = dayNamesNl[date.getDay()];
                            const monthName = monthNamesNl[date.getMonth()];
                            dateLabel = `${dayName} ${parseInt(day)} ${monthName} ${hour.toString().padStart(2, '0')}:00`;
                        } else {
                            const dayName = dayNamesEn[date.getDay()];
                            const monthName = monthNamesEn[date.getMonth()];
                            dateLabel = `${dayName} ${parseInt(day)} ${monthName} ${hour.toString().padStart(2, '0')}:00`;
                        }
                        
                        const pressureRaw = parseFloat(parts[14]);
                        if (isNaN(pressureRaw) || pressureRaw < 9000 || pressureRaw > 11000) continue;
                        
                        const pressure = pressureRaw / 10;
                        
                        allLabels.push(dateLabel);
                        allData.push(pressure);
                        allDates.push(date);
                    } catch (e) {
                        continue;
                    }
                }
            }
        }

        function createChart(dates, data) {
            const ctx = document.getElementById('pressureChart').getContext('2d');
            
            if (chart) chart.destroy();
            
            const chartData = dates.map((date, i) => ({ x: date, y: data[i] }));
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: t('pressure'),
                        data: chartData,
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: { enabled: false },
                                pinch: { enabled: false },
                                mode: 'x',
                                onZoom: (chart) => {
                                    const xScale = chart.scales.x;
                                    const max = xScale.max;
                                    xScale.options.min = xScale.min;
                                    xScale.options.max = max;
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: (items) => items[0]?.label || ''
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            ticks: {
                                maxTicksLimit: 20,
                                maxRotation: 45,
                                callback: function(value, index, values) {
                                    const date = new Date(value);
                                    const dayNames = currentLocale === 'nl' 
                                        ? ['Zo', 'Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za']
                                        : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                                    const monthNames = currentLocale === 'nl'
                                        ? ['jan', 'feb', 'mrt', 'apr', 'mei', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec']
                                        : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                    return dayNames[date.getDay()] + ' ' + date.getDate() + ' ' + monthNames[date.getMonth()];
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: t('pressure')
                            }
                        }
                    }
                }
            });
        }

        function filterRange(days) {
            if (allDates.length === 0) return;
            
            const lastDate = allDates[allDates.length - 1];
            const cutoffDate = new Date(lastDate.getTime() - days * 24 * 60 * 60 * 1000);
            
            const filteredDates = [];
            const filteredData = [];
            
            for (let i = 0; i < allDates.length; i++) {
                if (allDates[i] >= cutoffDate) {
                    filteredDates.push(allDates[i]);
                    filteredData.push(allData[i]);
                }
            }
            
            createChart(filteredDates, filteredData);
        }
    </script>
</body>
</html>
